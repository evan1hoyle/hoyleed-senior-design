<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Poker Visualizer</title>
    <style>
        :root {
            --table-green: #1a472a;
            --felt-green: #2d5a3f;
            --border-wood: #5d4037;
            --gold: #ffd700;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--table-green); 
            color: white; 
            margin: 0;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
        }

        h1 { text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

        .table { 
            background: var(--felt-green); 
            border: 12px solid var(--border-wood); 
            border-radius: 150px; 
            padding: 40px; 
            width: 90%; 
            max-width: 1000px; 
            box-shadow: inset 0 0 100px #000, 0 20px 40px rgba(0,0,0,0.5);
            position: relative; 
            min-height: 500px;
        }

        .section { margin-bottom: 30px; text-align: center; }
        
        .card-container { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            min-height: 150px;
            perspective: 1000px;
        }

        .card { 
            width: 100px; 
            height: 145px; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            position: relative;
            overflow: hidden;
            color: black;
        }

        .card img { 
            width: 85%; 
            height: auto; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }

        .conf-badge {
            position: absolute;
            bottom: 5px;
            background: rgba(0,0,0,0.7);
            color: #00ff00;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        .player-box { 
            background: rgba(0,0,0,0.2); 
            padding: 15px; 
            border-radius: 20px; 
            margin: 10px; 
            border: 1px solid rgba(255,255,255,0.1);
            flex: 1;
            transition: all 0.4s ease;
            text-align: center;
        }

        /* Winner Highlight Styles */
        .player-box.winner {
            border: 3px solid var(--gold);
            background: rgba(255, 215, 0, 0.15);
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
        }

        .winner-label {
            background: var(--gold);
            color: black;
            font-weight: bold;
            padding: 2px 12px;
            border-radius: 10px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 8px;
            animation: bounce 2s infinite;
        }

        .hand-type {
            font-style: italic;
            color: #bdc3c7;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-5px);}
            60% {transform: translateY(-3px);}
        }

        .flex-row { display: flex; justify-content: space-around; width: 100%; flex-wrap: wrap; }

        #status-light {
            width: 10px; height: 10px; background: #00ff00; border-radius: 50%;
            display: inline-block; margin-right: 5px; box-shadow: 0 0 5px #00ff00;
        }
    </style>
</head>
<body>

    <h1><span id="status-light"></span> LIVE POKER FEED</h1>

    <div class="table">
        <div class="section">
            <h2 style="color: var(--gold);">Community Board</h2>
            <div id="flop-container" class="card-container"></div>
        </div>

        <div class="flex-row" id="players-container">
            </div>
    </div>

    <script>
        const suitMap = { 'H': 'hearts', 'D': 'diamonds', 'S': 'spades', 'C': 'clubs' };
        const nameMap = { 'J': 'jack', 'Q': 'queen', 'K': 'king', 'A': 'ace', 'T': '10' };

        let lastStateString = "";

        function getImagePath(cardCode) {
            // Safety: Handle empty or partial card data to prevent .slice() errors
            if (!cardCode || cardCode.length < 2) {
                return 'https://placehold.co/100x140?text=...';
            }
            const value = cardCode.slice(0, -1);
            const suit = cardCode.slice(-1);
            const fullName = nameMap[value] || value;
            const fullSuit = suitMap[suit];
            return `card_images/${fullName}_of_${fullSuit}.png`;
        }

        async function updateDisplay() {
            try {
                const ts = new Date().getTime();
                const [pRes, fRes, wRes] = await Promise.all([
                    fetch(`/data/player_cards.json?t=${ts}`),
                    fetch(`/data/flop_cards.json?t=${ts}`),
                    fetch(`/data/winner.json?t=${ts}`)
                ]);

                const players = await pRes.json();
                const flop = await fRes.json();
                const winData = await wRes.json();

                const currentStateString = JSON.stringify({players, flop, winData});
                if (currentStateString === lastStateString) return;
                lastStateString = currentStateString;

                // Update Flop with filter
                const flopContainer = document.getElementById('flop-container');
                flopContainer.innerHTML = Object.values(flop)
                    .filter(card => card && card.name) 
                    .map((card, i) => `
                        <div class="card">
                            <img src="${getImagePath(card.name)}" onerror="this.src='https://placehold.co/100x140?text=?'">
                            <div class="conf-badge">${(card.conf * 100).toFixed(0)}%</div>
                        </div>
                    `).join('');

                // Update Players with Winner Logic
                const playerContainer = document.getElementById('players-container');
                playerContainer.innerHTML = Object.keys(players).map(id => {
                    const result = winData.results && winData.results[id];
                    const isWinner = result && result.is_winner;

                    return `
                        <div class="player-box ${isWinner ? 'winner' : ''}">
                            ${isWinner ? '<div class="winner-label">üèÜ WINNER</div>' : ''}
                            <h3>Player ${id}</h3>
                            <div class="hand-type">${result ? result.hand_type : 'Calculating...'}</div>
                            <div class="card-container">
                                ${Object.values(players[id])
                                    .filter(card => card && card.name)
                                    .map((card, i) => `
                                    <div class="card">
                                        <img src="${getImagePath(card.name)}" onerror="this.src='https://placehold.co/100x140?text=?'">
                                        <div class="conf-badge">${(card.conf * 100).toFixed(0)}%</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('status-light').style.background = '#00ff00';
                
            } catch (err) {
                document.getElementById('status-light').style.background = 'red';
                console.error("Polling error:", err);
            }
        }

        setInterval(updateDisplay, 1000);
        updateDisplay();
    </script>
</body>
</html>